<?php/*  Tu dies wieder rein, um von Hand zu berechnen......include("SCRIPTsession.php");include("SCRIPTconnect.php");include("SCRIPTinclude.php");include("../admin/admin_header.php");*/$textstyle = fontSizeColor(1, $txtcol8);// übergeben wurden  $wettkampfid, $spieltagecho "<br><br><h3 $center>" . $lang_calculating . " " . $wettkampfid . " - ";echo $lang_matchday . " " . $spieltag . "</h3><br>$textstyle" . $dreispace . $lang_pleasewait;$die_spiele = array();  // das sind die (max.) 9 spiel_id des $spieltag$heimtore = array();$gasttore = array();$die_user = array();$user_spieltag_punkte = array();$alte_spieltag_punkte = array();$user_wk_punkte = array();$old_HOF_rank = array();$old_HOF_punkte  = array();$old_wk_rank  = array();$neue_HOF_punkte  = array();// +++	1. Suche alle Spiele raus	++++++++++++++++++++++++++++++++++++++++++++echo ".";$spruch  = "SELECT id, tore_heim, tore_gast";$spruch .= " FROM liga_spiel";$spruch .= " WHERE wettkampf_id = $wettkampfid";$spruch .= " AND spieltag = $spieltag";$spruch .= " AND done = 1";$result = mysql_query( $spruch, $db ) or die("Query failed : " . mysql_error());while ($row = mysql_fetch_array($result, MYSQL_ASSOC))	{	$iddummy = $row['id'];	$die_spiele[] = $row['id'];	$heimtore[$iddummy] = $row['tore_heim'];	$gasttore[$iddummy] = $row['tore_gast'];#echo "<br>Spiel:" . $iddummy . "&nbsp(";#echo $heimtore[$iddummy] . ":" . $gasttore[$iddummy] . ") ...";	}// --- /1 ----------------------------------------------------------------------// +++	2. Suche alle Tipprunden, die bei $wettkampfid mitmachen ++++++++++++++++echo ".";$spruch  = "SELECT tippspiel_id";$spruch .= " FROM tippspiel_wettkampf";$spruch .= " WHERE wettkampf_id = $wettkampfid";$result = mysql_query( $spruch, $db ) or die("Query failed : " . mysql_error());while ($row = mysql_fetch_array($result, MYSQL_ASSOC))	{	$diese_runde  = $row['tippspiel_id'];echo ".";#echo "<br>.....Bin jetzt bei Tipprunde : " . $diese_runde;		// +++	2.1 Suche alle user, die bei $dieser_runde mitmachen ++++++++++++++++	// +++ 	2.1.2 und hol dir direkt die alten HOF punkte und ranksecho ".";#echo "<br>Suche die teilnehmenden User raus...";	$spruch2  = "SELECT user_id, rank, punkte";	$spruch2 .= " FROM tippspiel_user";	$spruch2 .= " WHERE tippspiel_id = $diese_runde";	$result2 = mysql_query( $spruch2, $db ) or die("Query failed : " . mysql_error());	while ($row2 = mysql_fetch_array($result2, MYSQL_ASSOC))		{		$dieser_user = $row2['user_id'];		$die_user[$dieser_user] = $row2['user_id'];		$old_HOF_rank[$dieser_user] = $row2['rank'];		$old_HOF_punkte[$dieser_user] = $row2['punkte'];#echo "<br><br>----- Bin bei User " . $dieser_user;#echo "...sein alter HallOfFame-Rank :<b>" . $old_HOF_rank[$dieser_user];#echo "</b>&nbsp;&nbsp;<i>(" .	$old_HOF_punkte[$dieser_user] . " Punkte)</i>";echo ".";			// alte spieltagpunkte vorhanden ? ----		$spruch3  = "SELECT id, punkte";		$spruch3 .= " FROM ranking";		$spruch3 .= " WHERE spieltag = $spieltag";		$spruch3 .= " AND user_id = $dieser_user";		$spruch3 .= " AND tippspiel_id = $diese_runde";		$spruch3 .= " AND wettkampf_id = $wettkampfid";		$result3 = mysql_query( $spruch3, $db ) or die("Query failed : " . mysql_error());		$row3 = mysql_fetch_array($result3, MYSQL_ASSOC);				$gibtzdas = $row3['id'];		$alte_spieltag_punkte[$dieser_user] = $row3['punkte'];echo ".";#echo "... bis jetzt hatte er " . $alte_spieltag_punkte[$dieser_user] . " Punkte für diesen Spieltag bekommen";		//---------------------------------------------------------------		// gibtz da schon nen db eintrag ?		if (!$gibtzdas)			{echo ".";#echo "<b>... deshalb schreiben wir mal nen neuen DB eintrag !</b>";						$sprich = "INSERT INTO ranking";			$sprich .= " (user_id, wettkampf_id, tippspiel_id, spieltag)";			$sprich .= " VALUES ($dieser_user, $wettkampfid, $diese_runde, $spieltag)";					$resilt = mysql_query($sprich, $db);				}		// ----------------------------------------------------		$user_spieltag_punkte[$dieser_user] = 0;					// +++ 	2.2.1 gehe alle spiele durch, hol dir den usertip +++++++++++++++++++++++++++echo ".";#echo "<br>ok, dann geh ich mal die ganzen spiele durch mit ihm...";		foreach($die_spiele as $spiel)			{			$heim_echt = $heimtore[$spiel];			$gast_echt = $gasttore[$spiel];echo ".";#echo "<br>+++++ jetzt für spiel" . $spiel . "(" . $heim_echt . ":" . $gast_echt . ") ..";					$spruch3  = "SELECT id, heim_tip, gast_tip";			$spruch3 .= " FROM liga_tip";			$spruch3 .= " WHERE liga_spiel_id = $spiel";			$spruch3 .= " AND user_id = $dieser_user";			$result3 = mysql_query( $spruch3, $db ) or die("Query failed : " . mysql_error());			$row3 = mysql_fetch_array($result3, MYSQL_ASSOC);					$tipid = $row3['id'];			$heim_tip = $row3['heim_tip'];			$gast_tip = $row3['gast_tip'];echo ".";#echo "... er hat getippt: " . 	$heim_tip . ":" . $gast_tip . " &nbsp;";			// +++ 2.2.2 Vergleich, und punkte errechnen ++++++++++++++++++++++++++++									// punkte fuer dieses spiel berechnen			$pzaehler="0";			if ($heim_echt == $heim_tip) $pzaehler++;			if ($gast_echt == $gast_tip) $pzaehler++;			if ($heim_echt > $gast_echt && $heim_tip > $gast_tip) $pzaehler++;			if ($heim_echt < $gast_echt && $heim_tip < $gast_tip) $pzaehler++;			if ($heim_echt == $gast_echt && $heim_tip == $gast_tip) $pzaehler++;						#echo " <b> " . $pzaehler . " </b> ";			// DETEKTIV ! ------------------			if ($heim_tip == "") $pzaehler="0";			// ----------------------------- #echo "..und bekommt dafür  <b> " . $pzaehler ." </b> Punkte";				$user_spieltag_punkte[$dieser_user] = ($user_spieltag_punkte[$dieser_user] + $pzaehler);	#echo "..(bis jetzt hatta " . $user_spieltag_punkte[$dieser_user] . " insgesamt...";echo "."; 			// -------  Punkte abspeichern  ----------				$sprich = "UPDATE liga_tip SET";			$sprich .= " punkte = $pzaehler";					$sprich .= " WHERE id = $tipid";			$resilt = mysql_query($sprich, $db);			}			//------		// An dieser Stelle hab ich für den User den Spieltag durchgerechnet, punkte gespeichert		// und jetzt sind die gesamt_spieltag punkte in $user_spieltag_punkte[$dieser_user] 		// gespeichert		$in_die_db = $user_spieltag_punkte[$dieser_user];#echo "<br> so, ich speicher fuer user " . $dieser_user . "&nbsp; die Punktzahl " . $in_die_db . " fuer diesen spieltag ab !";echo ".";		$sprich = "UPDATE ranking SET";		$sprich .= " punkte = $in_die_db";				$sprich .= " WHERE spieltag = $spieltag";		$sprich .= " AND user_id = $dieser_user";		$sprich .= " AND tippspiel_id = $diese_runde";		$sprich .= " AND wettkampf_id = $wettkampfid";		$resilt = mysql_query($sprich, $db);							// 2.3 Hole dir den alten rank des users von dem wettkampf in der tipprunde	    $spieltag1 = ($spieltag - 1);		$spruch3  = "SELECT rank";		$spruch3 .= " FROM ranking";		$spruch3 .= " WHERE wettkampf_id = $wettkampfid";		$spruch3 .= " AND user_id = $dieser_user";		$spruch3 .= " AND tippspiel_id = $diese_runde";		if ($spieltag > 1) $spruch3 .= " AND spieltag = $spieltag1";		$result3 = mysql_query( $spruch3, $db ) or die("Query failed : " . mysql_error());		$row3 = mysql_fetch_array($result3, MYSQL_ASSOC);			$old_wk_rank[$dieser_user] = $row3['rank'];#echo "<br>,,,, der user war vorher auf rank " . $old_wk_rank[$dieser_user];echo ".";				// hol dir die gesamtpunkte des user fuer den wettkampf raus		$spruch3  = "SELECT punkte, SUM(punkte) AS wkpunkte";		$spruch3 .= " FROM ranking";		$spruch3 .= " WHERE wettkampf_id = $wettkampfid";		$spruch3 .= " AND user_id = $dieser_user";		$spruch3 .= " AND tippspiel_id = $diese_runde";		$spruch3 .= " GROUP BY user_id";		$result3 = mysql_query( $spruch3, $db ) or die("Query failed : " . mysql_error());		$row3 = mysql_fetch_array($result3, MYSQL_ASSOC);				$user_wk_punkte[$dieser_user] = $row3['wkpunkte'];#echo "--- jetz hatta fuer diesem wettkampf insgesamt " .	$user_wk_punkte[$dieser_user] . " Punkte geholt";			// direkt in die HOF mit einbeziehen		$neue_HOF_punkte[$dieser_user]	=	($old_HOF_punkte[$dieser_user] - $alte_spieltag_punkte[$dieser_user] + $user_spieltag_punkte[$dieser_user]);			#echo ".. (in der HOF ergibt das insg. " . $neue_HOF_punkte[$dieser_user] . " Punkte)";echo ".";		}			// hier bin ich in der tiprunde, und hab alle userinfos in den arrays	//fang wa mal an zu ranken fuer den wettkampf#echo "<br><hr><br>so, jetzt bin ich mit allen usern der tiprunde " . $diese_runde . " durch und fang an zu ranken....<br>";echo ".";		array_multisort ($user_wk_punkte, SORT_DESC, SORT_NUMERIC, $die_user, $neue_HOF_punkte, $old_HOF_rank, $old_wk_rank);	$platzierung = 0;$punkte_detektiv = 0;$doppeltcounter=0;$dasflag=0;	for ($o=0;$o<count($die_user);$o++)		{		$dieser_user_id = $die_user[$o];				// --teilt sich der user den platz mit wem ?! --------				if ($user_wk_punkte[$o] == $punkte_detektiv)			{             #echo "<br>[teilt sich den platz]";             $doppeltcounter++;             $dasflag=1;            } else {            if ($dasflag==1) {                $platzierung = ($platzierung + $doppeltcounter +1);                $doppeltcounter=0;                $dasflag=0;			 } else {			 $platzierung++;			 			 }			 #echo "<br>";			}	    		$punkte_detektiv = $user_wk_punkte[$o];			// ---------------------------------------------------				#echo "...Auf Platz " . $platzierung . " : &nbsp; &nbsp; User ";#echo $die_user[$o];#echo " mit " . $user_wk_punkte[$o] . " Punkten";echo ".";		// daumen faxe durchranken -------------------------		if ($platzierung == $old_wk_rank[$o]) 			{#echo " ...(gleichgeblieben)";			$daumenflag = 1; // gleichgeblieben			}		if ($platzierung < $old_wk_rank[$o]) 			{#echo " ...(aufgestiegen)";			$daumenflag = 2; // aufgestiegen			}		if ($platzierung > $old_wk_rank[$o]) 			{#echo " ...(abgestiegen)";			$daumenflag = 3; // abgestiegen			}		// -------------------------------------------------	#echo " <br> Das speicher ich mal so in <i>ranking</i> ab....";echo ".";		$sprich = "UPDATE ranking SET";		$sprich .= " daumen_flag = $daumenflag,";		$sprich .= " rank = $platzierung";				$sprich .= " WHERE user_id = $dieser_user_id";		$sprich .= " AND tippspiel_id = $diese_runde";		$sprich .= " AND wettkampf_id = $wettkampfid";		$sprich .= " AND spieltag = $spieltag";		$resilt = mysql_query($sprich, $db);			}#echo "<br><br>Wettkampf fertig gerankt fuer Tipprunde " . $diese_runde;#echo "... jetzt gehtz an die <b>HallOfFame</b>....";echo ".";			array_multisort ($neue_HOF_punkte, SORT_DESC, SORT_NUMERIC, $die_user, $old_HOF_rank);	$HOFplatzierung = 0;$HOFpunkte_detektiv = 0;$aufschlag=0;$dasflag=0;	for ($o=0;$o<count($die_user);$o++)		{		$dieser_user_id = $die_user[$o];				// --teilt sich der user den platz mit wem ?! --------				if ($neue_HOF_punkte[$o] == $HOFpunkte_detektiv)			{                #echo "[teilt sich den platz]";                $aufschlag++;                $dasflag=1;			} else {			    if ($dasflag==1) {			    $HOFplatzierung = ($HOFplatzierung + $aufschlag + 1);			    $aufschlag = 0;			    $dasflag = 0;			    }else {			    $HOFplatzierung++;			    }			}		$HOFpunkte_detektiv = $neue_HOF_punkte[$o];			// ---------------------------------------------------				#echo "<br>Auf Platz " . $HOFplatzierung . " : &nbsp; &nbsp; User ";#echo $die_user[$o];#echo " mit " . $neue_HOF_punkte[$o] . " Punkten";echo ".";		// daumen faxe durchranken -------------------------		if ($HOFplatzierung == $old_HOF_rank[$o]) 			{#echo " ...(gleichgeblieben)";			$HOFdaumenflag = 1; // gleichgeblieben			}		if ($HOFplatzierung < $old_HOF_rank[$o]) 			{#echo " ...(aufgestiegen)";			$HOFdaumenflag = 2; // aufgestiegen			}		if ($HOFplatzierung > $old_HOF_rank[$o]) 			{#echo " ...(abgestiegen)";			$HOFdaumenflag = 3; // abgestiegen			}		// -------------------------------------------------	#echo " <br> Das speicher ich mal so in <i>tippspie_user</i> ab....";echo ".";		$sprich = "UPDATE tippspiel_user SET";		$sprich .= " daumen_flag = $HOFdaumenflag,";		$sprich .= " punkte = $neue_HOF_punkte[$o],";		$sprich .= " rank = $HOFplatzierung";				$sprich .= " WHERE user_id = $dieser_user_id";		$sprich .= " AND tippspiel_id = $diese_runde";		$resilt = mysql_query($sprich, $db);			}#echo "<br><hr><br>So, ich w&auml;re denn soweit...";#echo "und mit der Tiprunde " . $diese_runde . " fertig....<br>";echo ".";		// hier muss ich noch den alle arrays $die_user, $user_wk_punkte, $neue_HOF_punkte, loeschen#echo "...ich loesche noch schnell die arrays...<br><br>";	$die_user = "";		$user_wk_punkte = "";		$neue_HOF_punkte = "";	$old_HOF_rank = "";	$old_HOF_punkte = "";	$old_wk_rank = "";	$user_spieltag_punkte = "";	$alte_spieltag_punkte = "";	}		// so... jetzt bin ich mit den tiprunden durch	#echo "<br><br><b>ICH ERMITTLE NUN DEN aktuellen spieltag !!</b>";echo ".";	$spruch = "SELECT spieltag FROM liga_spiel";	$spruch .= " WHERE wettkampf_id = $wettkampfid";	$spruch .= " AND done = 1";	$spruch .= " ORDER BY spieltag DESC"; 	$result = mysql_query($spruch, $db);		$row = mysql_fetch_array($result, MYSQL_ASSOC);	$der_spieltag = $row['spieltag'];	#	echo "<br> Meiner Berechnung nach ist der aktuelle Spieltag = " . $der_spieltag;	$sprich  = "UPDATE wettkampf";	$sprich .= " SET akt_spieltag = $der_spieltag";	$sprich .= " WHERE id = $wettkampfid";	$resilt = mysql_query($sprich, $db);#	echo "<br>....das habbich mal so in die db gespeichert...";echo "<br><br><b>". $dreispace . $lang_done . "</b><br><br>"; 	//// --- /2 -----------------------------------------------------------------------	?>